<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blax Search - –õ—É—á—à–∏–π —Å–µ—Ä—á–µ—Ä</title>
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            min-height: 100vh;
            color: #f0f0f0;
            position: relative;
            overflow-x: hidden;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 20px 100px;
        }

        /* –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –º–µ–Ω—é */
        .global-nav {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(138, 138, 255, 0.2);
            z-index: 1000;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #8a8aff 0%, #6464ff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #8a8aff 0%, #6464ff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ */
        .file-drop-area {
            border: 2px dashed rgba(138, 138, 255, 0.5);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
            position: relative;
        }

        .file-drop-area:hover {
            border-color: #8a8aff;
            background: rgba(138, 138, 255, 0.05);
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
        .upload-progress {
            margin-top: 20px;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(138, 138, 255, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8a8aff 0%, #6464ff 100%);
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è */
        .large-file-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        /* –†–µ–∂–∏–º—ã –∑–∞–≥—Ä—É–∑–∫–∏ */
        .upload-modes {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(138, 138, 255, 0.3);
            border-radius: 10px;
            color: #a3a3ff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .mode-btn.active {
            background: rgba(138, 138, 255, 0.2);
            border-color: #8a8aff;
            color: #ffffff;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .search-input {
            flex: 1;
            padding: 18px 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(138, 138, 255, 0.3);
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #8a8aff;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 30px rgba(138, 138, 255, 0.3);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 18px 30px;
            border-radius: 15px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8a8aff 0%, #6464ff 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(138, 138, 255, 0.4);
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã */
        .results-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .result-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(to bottom, #8a8aff, #6464ff);
            border-radius: 4px 0 0 4px;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 12px;
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(138, 138, 255, 0.3);
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .message.show {
            transform: translateX(0);
        }

        .message.success {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .message.error {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loader {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(138, 138, 255, 0.3);
            border-radius: 50%;
            border-top-color: #8a8aff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .container {
                padding: 100px 15px 130px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –º–µ–Ω—é -->
    <nav class="global-nav">
        <div class="nav-brand">
            <span>üîç</span>
            <span>Advanced Text Search</span>
        </div>
        <div class="nav-stats">
            <span id="memoryInfo" style="color: #a3a3ff; font-size: 0.9rem;">
                –ü–∞–º—è—Ç—å: <span id="memoryUsage">0 –ú–ë</span>
            </span>
        </div>
    </nav>

    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header">
            <h1>üîç –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É</h1>
            <p style="color: #a3a3ff; max-width: 600px; margin: 0 auto;">
                –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–æ 1 –ì–ë ‚Ä¢ –ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Ä¢ –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏
            </p>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
        <div class="glass-card">
            <h2 style="color: #ffffff; margin-bottom: 25px; font-size: 1.8rem;">
                üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª (–¥–æ 1 –ì–ë)
            </h2>
            
            <div class="file-drop-area" id="fileDropArea">
                <div style="font-size: 4rem; margin-bottom: 20px; color: #8a8aff;">üìÑ</div>
                <p style="font-size: 1.2rem; margin-bottom: 10px; color: #ffffff;">
                    –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ .txt —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
                </p>
                <p style="color: #a3a3ff; font-size: 0.9rem;">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã –¥–æ 1 –ì–ë
                </p>
                <div style="margin-top: 20px; padding: 10px; background: rgba(138, 138, 255, 0.1); border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #a3a3ff;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–µ–∂–∏–º:</span>
                        <span id="recommendedMode" style="color: #8a8aff; font-weight: 600;">–ê–≤—Ç–æ</span>
                    </div>
                    <div style="color: #a3a3ff; font-size: 0.85rem;">
                        <span>–ë—Ä–∞—É–∑–µ—Ä–Ω—ã–π –ª–∏–º–∏—Ç: ~1.5 –ì–ë RAM</span>
                    </div>
                </div>
                <input type="file" id="fileInput" accept=".txt" style="display: none;">
            </div>
            
            <!-- –†–µ–∂–∏–º—ã –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="upload-modes">
                <button id="modeFast" class="mode-btn active" data-mode="fast">
                    ‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">–¥–æ 100 –ú–ë</div>
                </button>
                <button id="modeStream" class="mode-btn" data-mode="stream">
                    üîÑ –ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">100-500 –ú–ë</div>
                </button>
                <button id="modeChunk" class="mode-btn" data-mode="chunk">
                    üß© –ü–æ —á–∞—Å—Ç—è–º
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">500 –ú–ë - 1 –ì–ë</div>
                </button>
            </div>
            
            <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ -->
            <div id="largeFileWarning" class="large-file-warning">
                <div style="display: flex; align-items: center; gap: 10px; color: #ffc107; font-weight: 600; margin-bottom: 10px;">
                    <span>‚ö†Ô∏è</span>
                    <span>–ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª –æ–±–Ω–∞—Ä—É–∂–µ–Ω</span>
                </div>
                <div style="color: #ffd54f; font-size: 0.9rem; line-height: 1.4;">
                    –î–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º –ø–æ—Ç–æ–∫–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                </div>
            </div>
            
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="uploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-container">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #ffffff; font-weight: 600;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</span>
                        <span style="color: #a3a3ff;" id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; color: #a3a3ff; font-size: 0.9rem;">
                        <span id="loadedSize">0 –ë</span>
                        <span id="totalSize">0 –ë</span>
                    </div>
                    <div style="margin-top: 10px; color: #8a8aff; font-size: 0.85rem;">
                        –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: <span id="processedLines">0</span>
                    </div>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã -->
                <button id="cancelBtn" class="btn" style="width: 100%; margin-top: 15px; background: rgba(255, 90, 90, 0.2); color: #ff9e9e;">
                    ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
                </button>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ -->
            <div id="fileInfo" class="file-info" style="margin-top: 20px; display: none;">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="glass-card">
            <h2 style="color: #ffffff; margin-bottom: 25px; font-size: 1.8rem;">
                üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
            </h2>
            
            <div class="search-box">
                <input type="text" 
                       id="searchInput" 
                       class="search-input" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É –¥–ª—è –ø–æ–∏—Å–∫–∞..."
                       disabled>
                <button id="searchBtn" class="btn btn-primary" disabled>
                    <span>–ü–æ–∏—Å–∫</span>
                    <span>üîç</span>
                </button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <button id="copyAllBtn" class="btn" style="background: rgba(255, 255, 255, 0.1); color: white;" disabled>
                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ
                </button>
                <button id="exportBtn" class="btn" style="background: rgba(255, 255, 255, 0.1); color: white;" disabled>
                    üì§ –≠–∫—Å–ø–æ—Ä—Ç
                </button>
                <button id="clearBtn" class="btn" style="background: rgba(255, 255, 255, 0.1); color: white;">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="color: #ffffff; font-size: 1.5rem;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                <div style="color: #a3a3ff; font-weight: 600;">
                    –ù–∞–π–¥–µ–Ω–æ: <span id="resultsCount">0</span> —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                </div>
            </div>
            
            <div id="resultsContainer" class="results-container">
                <div style="text-align: center; padding: 60px 20px; color: #a3a3ff;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üîç</div>
                    <p style="font-size: 1.2rem; margin-bottom: 10px;">
                        –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏ –Ω–∞—á–Ω–∏—Ç–µ –ø–æ–∏—Å–∫
                    </p>
                    <p style="opacity: 0.7;">
                        –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="message" class="message"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="background.js"></script>
    <script src="menu.js"></script>
    <script src="script.js"></script>

    <script>
        // –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç (–æ—Å—Ç–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ —Å–∞–º–æ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ)
        let currentFile = null;
        let searchResults = [];
        let fileIndex = [];
        let currentMode = 'fast';
        let isProcessing = false;
        let cancelRequested = false;
        
        const MODES = {
            fast: { maxSize: 100 * 1024 * 1024, chunkSize: 1024 * 1024 },
            stream: { maxSize: 500 * 1024 * 1024, chunkSize: 512 * 1024 },
            chunk: { maxSize: 1024 * 1024 * 1024, chunkSize: 256 * 1024 }
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const elements = {
            fileInput: document.getElementById('fileInput'),
            fileDropArea: document.getElementById('fileDropArea'),
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            clearBtn: document.getElementById('clearBtn'),
            copyAllBtn: document.getElementById('copyAllBtn'),
            exportBtn: document.getElementById('exportBtn'),
            resultsContainer: document.getElementById('resultsContainer'),
            resultsCount: document.getElementById('resultsCount'),
            uploadProgress: document.getElementById('uploadProgress'),
            progressFill: document.getElementById('progressFill'),
            progressPercent: document.getElementById('progressPercent'),
            loadedSize: document.getElementById('loadedSize'),
            totalSize: document.getElementById('totalSize'),
            processedLines: document.getElementById('processedLines'),
            modeFast: document.getElementById('modeFast'),
            modeStream: document.getElementById('modeStream'),
            modeChunk: document.getElementById('modeChunk'),
            recommendedMode: document.getElementById('recommendedMode'),
            largeFileWarning: document.getElementById('largeFileWarning'),
            fileInfo: document.getElementById('fileInfo'),
            memoryUsage: document.getElementById('memoryUsage'),
            memoryInfo: document.getElementById('memoryInfo'),
            cancelBtn: document.getElementById('cancelBtn'),
            message: document.getElementById('message')
        };

        function formatBytes(bytes) {
            if (bytes === 0) return '0 –ë';
            const k = 1024;
            const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getMemoryUsage() {
            if (window.performance && window.performance.memory) {
                const used = window.performance.memory.usedJSHeapSize;
                const total = window.performance.memory.totalJSHeapSize;
                const limit = window.performance.memory.jsHeapSizeLimit;
                return {
                    used: Math.round(used / 1024 / 1024),
                    total: Math.round(total / 1024 / 1024),
                    limit: Math.round(limit / 1024 / 1024),
                    percent: Math.round((used / limit) * 100)
                };
            }
            return { used: 0, total: 0, limit: 1500, percent: 0 };
        }

        function updateMemoryInfo() {
            const mem = getMemoryUsage();
            elements.memoryUsage.textContent = `${mem.used} –ú–ë (${mem.percent}%)`;
            
            if (mem.percent > 80) {
                elements.memoryInfo.style.color = '#ff6b6b';
            } else if (mem.percent > 60) {
                elements.memoryInfo.style.color = '#ffc107';
            } else {
                elements.memoryInfo.style.color = '#a3a3ff';
            }
        }

        function showMessage(text, type = 'info') {
            const message = elements.message;
            message.textContent = text;
            message.className = `message ${type} show`;
            
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }

        function getRecommendedMode(fileSize) {
            if (fileSize <= MODES.fast.maxSize) return 'fast';
            if (fileSize <= MODES.stream.maxSize) return 'stream';
            return 'chunk';
        }

        function setMode(mode) {
            currentMode = mode;
            [elements.modeFast, elements.modeStream, elements.modeChunk].forEach(btn => {
                btn.classList.remove('active');
            });
            elements[`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`].classList.add('active');
            
            if (currentFile) {
                const recommended = getRecommendedMode(currentFile.size);
                elements.recommendedMode.textContent = recommended === mode ? '–í—ã–±—Ä–∞–Ω' : recommended;
            }
        }

        function readChunkAsText(chunk) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(chunk, 'UTF-8');
            });
        }

        async function createFileIndex(file, mode) {
            fileIndex = [];
            let lineNumber = 1;
            let processedBytes = 0;
            const chunkSize = MODES[mode].chunkSize;
            const totalChunks = Math.ceil(file.size / chunkSize);
            
            for (let i = 0; i < totalChunks; i++) {
                if (cancelRequested) {
                    showMessage('–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞', 'error');
                    return false;
                }
                
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);
                
                const chunkText = await readChunkAsText(chunk);
                const lines = chunkText.split('\n');
                
                for (let j = 0; j < lines.length; j++) {
                    fileIndex.push({
                        number: lineNumber++,
                        startByte: start,
                        chunkIndex: i,
                        lineIndex: j
                    });
                }
                
                processedBytes += chunkSize;
                const percent = Math.round((processedBytes / file.size) * 100);
                elements.progressFill.style.width = `${percent}%`;
                elements.progressPercent.textContent = `${percent}%`;
                elements.processedLines.textContent = (lineNumber - 1).toLocaleString();
                
                await new Promise(resolve => setTimeout(resolve, 0));
                
                if (i % 10 === 0) {
                    updateMemoryInfo();
                    if (getMemoryUsage().percent > 85) {
                        showMessage('–ú–∞–ª–æ –ø–∞–º—è—Ç–∏! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...', 'error');
                        return false;
                    }
                }
            }
            
            return true;
        }

        async function searchInFile(searchTerm) {
            if (!currentFile || fileIndex.length === 0) {
                showMessage('–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return [];
            }
            
            const results = [];
            const termLower = searchTerm.toLowerCase();
            const chunkSize = MODES[currentMode].chunkSize;
            let chunksProcessed = new Set();
            
            for (const item of fileIndex) {
                if (cancelRequested) break;
                
                if (!chunksProcessed.has(item.chunkIndex)) {
                    const start = item.chunkIndex * chunkSize;
                    const end = Math.min(start + chunkSize, currentFile.size);
                    const chunk = currentFile.slice(start, end);
                    const chunkText = await readChunkAsText(chunk);
                    
                    chunksProcessed.add(item.chunkIndex);
                    window[`chunk_${item.chunkIndex}`] = chunkText;
                }
                
                const chunkText = window[`chunk_${item.chunkIndex}`];
                const lines = chunkText.split('\n');
                const line = lines[item.lineIndex];
                
                if (line && line.toLowerCase().includes(termLower)) {
                    const positions = [];
                    let pos = line.toLowerCase().indexOf(termLower);
                    while (pos !== -1) {
                        positions.push(pos);
                        pos = line.toLowerCase().indexOf(termLower, pos + 1);
                    }
                    
                    results.push({
                        lineNumber: item.number,
                        content: line,
                        searchTerm: searchTerm,
                        positions: positions,
                        chunkIndex: item.chunkIndex,
                        lineIndex: item.lineIndex
                    });
                }
                
                if (results.length >= 1000) {
                    showMessage('–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 1000 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', 'warning');
                    break;
                }
                
                if (results.length % 100 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
            
            chunksProcessed.forEach(index => {
                delete window[`chunk_${index}`];
            });
            
            return results;
        }

        async function handleFileUpload(file) {
            cancelRequested = false;
            isProcessing = true;
            currentFile = file;
            
            if (file.size > MODES.chunk.maxSize) {
                showMessage(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 1 –ì–ë`, 'error');
                return;
            }
            
            const recommendedMode = getRecommendedMode(file.size);
            setMode(recommendedMode);
            
            if (file.size > MODES.fast.maxSize) {
                elements.largeFileWarning.style.display = 'block';
            }
            
            elements.uploadProgress.style.display = 'block';
            elements.fileInfo.style.display = 'none';
            elements.progressFill.style.width = '0%';
            elements.progressPercent.textContent = '0%';
            elements.loadedSize.textContent = '0 –ë';
            elements.totalSize.textContent = formatBytes(file.size);
            
            showMessage('–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ —Ñ–∞–π–ª–∞...', 'info');
            const indexCreated = await createFileIndex(file, currentMode);
            
            if (!indexCreated || cancelRequested) {
                elements.uploadProgress.style.display = 'none';
                isProcessing = false;
                return;
            }
            
            elements.uploadProgress.style.display = 'none';
            elements.fileInfo.style.display = 'block';
            elements.fileInfo.innerHTML = `
                <div style="color: #ffffff; font-weight: 600; font-size: 1.2rem; margin-bottom: 10px;">
                    ${file.name}
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(138, 138, 255, 0.1); padding: 10px; border-radius: 8px;">
                        <div style="color: #a3a3ff; font-size: 0.9rem;">–†–∞–∑–º–µ—Ä</div>
                        <div style="color: #ffffff; font-weight: 600;">${formatBytes(file.size)}</div>
                    </div>
                    <div style="background: rgba(138, 138, 255, 0.1); padding: 10px; border-radius: 8px;">
                        <div style="color: #a3a3ff; font-size: 0.9rem;">–°—Ç—Ä–æ–∫</div>
                        <div style="color: #ffffff; font-weight: 600;">${fileIndex.length.toLocaleString()}</div>
                    </div>
                </div>
                <div style="color: #8a8aff; font-size: 0.9rem; padding: 10px; background: rgba(138, 138, 255, 0.1); border-radius: 8px;">
                    <span>–†–µ–∂–∏–º:</span> ${currentMode === 'fast' ? '‚ö° –ë—ã—Å—Ç—Ä—ã–π' : currentMode === 'stream' ? 'üîÑ –ü–æ—Ç–æ–∫–æ–≤—ã–π' : 'üß© –ü–æ —á–∞—Å—Ç—è–º'}
                </div>
            `;
            
            elements.searchInput.disabled = false;
            elements.searchBtn.disabled = false;
            elements.copyAllBtn.disabled = false;
            elements.exportBtn.disabled = false;
            
            showMessage(`–§–∞–π–ª "${file.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!`, 'success');
            isProcessing = false;
            updateMemoryInfo();
        }

        async function performSearch() {
            const searchTerm = elements.searchInput.value.trim();
            
            if (!searchTerm) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'warning');
                return;
            }
            
            if (!currentFile) {
                showMessage('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª', 'warning');
                return;
            }
            
            elements.searchBtn.disabled = true;
            elements.searchBtn.innerHTML = '<div class="loader" style="width: 20px; height: 20px;"></div>';
            
            const startTime = Date.now();
            searchResults = await searchInFile(searchTerm);
            const searchTime = Date.now() - startTime;
            
            elements.resultsCount.textContent = searchResults.length;
            displayResults();
            
            elements.searchBtn.disabled = false;
            elements.searchBtn.innerHTML = '<span>–ü–æ–∏—Å–∫</span><span>üîç</span>';
            showMessage(`–ù–∞–π–¥–µ–Ω–æ ${searchResults.length} —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –∑–∞ ${searchTime}–º—Å`, 'success');
        }

        function displayResults() {
            const container = elements.resultsContainer;
            
            if (searchResults.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #a3a3ff;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üîç</div>
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">
                            –ü–æ –∑–∞–ø—Ä–æ—Å—É "<span style="color: #8a8aff;">${elements.searchInput.value}</span>" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                        </p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            for (let i = 0; i < Math.min(searchResults.length, 100); i++) {
                const result = searchResults[i];
                let highlightedContent = result.content;
                
                result.positions.sort((a, b) => b - a).forEach(pos => {
                    const end = pos + result.searchTerm.length;
                    highlightedContent = 
                        highlightedContent.substring(0, pos) +
                        `<mark style="background: #ffeb3b; color: #000; padding: 2px 4px; border-radius: 3px;">${highlightedContent.substring(pos, end)}</mark>` +
                        highlightedContent.substring(end);
                });
                
                html += `
                    <div class="result-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background: linear-gradient(135deg, #8a8aff 0%, #6464ff 100%); color: white; padding: 6px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                                    –°—Ç—Ä–æ–∫–∞ #${result.lineNumber}
                                </span>
                                <span style="color: #a3a3ff; font-size: 0.9rem;">
                                    ${result.positions.length} –≤—Ö–æ–∂–¥–µ–Ω–∏–π
                                </span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="copy-line" data-line="${result.lineNumber}" data-content="${result.content.replace(/"/g, '&quot;')}" style="background: rgba(138, 138, 255, 0.1); border: 1px solid rgba(138, 138, 255, 0.3); color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        </div>
                        <div style="color: #ffffff; font-family: monospace; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; white-space: pre-wrap; word-break: break-all;">
                            ${highlightedContent}
                        </div>
                    </div>
                `;
            }
            
            if (searchResults.length > 100) {
                html += `
                    <div style="text-align: center; padding: 20px; color: #ffc107;">
                        <span>‚ö†Ô∏è –ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 100 –∏–∑ ${searchResults.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</span>
                        <div style="margin-top: 10px;">
                            <button id="loadMoreBtn" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); color: #ffc107; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ 100
                            </button>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            container.querySelectorAll('.copy-line').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const line = e.target.dataset.line;
                    const content = e.target.dataset.content;
                    navigator.clipboard.writeText(content);
                    showMessage(`–°—Ç—Ä–æ–∫–∞ ${line} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!`, 'success');
                });
            });
            
            if (searchResults.length > 100) {
                document.getElementById('loadMoreBtn')?.addEventListener('click', () => {
                    showMessage('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
                });
            }
        }

        async function copyAllResults() {
            if (searchResults.length === 0) {
                showMessage('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'warning');
                return;
            }
            
            let text = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: "${elements.searchInput.value}"\n`;
            text += `–§–∞–π–ª: ${currentFile.name}\n`;
            text += `–ù–∞–π–¥–µ–Ω–æ: ${searchResults.length} —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π\n\n`;
            
            const limit = Math.min(searchResults.length, 100);
            for (let i = 0; i < limit; i++) {
                const result = searchResults[i];
                text += `[–°—Ç—Ä–æ–∫–∞ ${result.lineNumber}]: ${result.content}\n`;
            }
            
            if (searchResults.length > 100) {
                text += `\n... –∏ –µ—â–µ ${searchResults.length - 100} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n`;
            }
            
            await navigator.clipboard.writeText(text);
            showMessage(`${limit} —Å—Ç—Ä–æ–∫ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!`, 'success');
        }

        function exportResults() {
            if (searchResults.length === 0) {
                showMessage('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
                return;
            }
            
            let content = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: "${elements.searchInput.value}"\n`;
            content += `–§–∞–π–ª: ${currentFile.name}\n`;
            content += `–í—Ä–µ–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞: ${new Date().toLocaleString()}\n`;
            content += `–ù–∞–π–¥–µ–Ω–æ: ${searchResults.length} —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π\n\n`;
            
            searchResults.forEach(result => {
                content += `[–°—Ç—Ä–æ–∫–∞ ${result.lineNumber}]: ${result.content}\n`;
            });
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `search_results_${currentFile.name}_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!`, 'success');
        }

        function clearResults() {
            searchResults = [];
            elements.searchInput.value = '';
            elements.resultsCount.textContent = '0';
            elements.resultsContainer.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #a3a3ff;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üîç</div>
                    <p style="font-size: 1.2rem; margin-bottom: 10px;">
                        –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏ –Ω–∞—á–Ω–∏—Ç–µ –ø–æ–∏—Å–∫
                    </p>
                    <p style="opacity: 0.7;">
                        –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å
                    </p>
                </div>
            `;
            
            showMessage('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã', 'info');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            setInterval(updateMemoryInfo, 2000);
            
            elements.modeFast.addEventListener('click', () => setMode('fast'));
            elements.modeStream.addEventListener('click', () => setMode('stream'));
            elements.modeChunk.addEventListener('click', () => setMode('chunk'));
            
            elements.fileDropArea.addEventListener('click', () => {
                elements.fileInput.click();
            });
            
            elements.fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.fileDropArea.style.borderColor = '#8a8aff';
                elements.fileDropArea.style.background = 'rgba(138, 138, 255, 0.1)';
            });
            
            elements.fileDropArea.addEventListener('dragleave', () => {
                elements.fileDropArea.style.borderColor = '';
                elements.fileDropArea.style.background = '';
            });
            
            elements.fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.fileDropArea.style.borderColor = '';
                elements.fileDropArea.style.background = '';
                
                const file = e.dataTransfer.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });
            
            elements.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });
            
            elements.cancelBtn.addEventListener('click', () => {
                cancelRequested = true;
            });
            
            elements.searchBtn.addEventListener('click', performSearch);
            elements.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
            
            elements.clearBtn.addEventListener('click', clearResults);
            elements.copyAllBtn.addEventListener('click', copyAllResults);
            elements.exportBtn.addEventListener('click', exportResults);
        });
    </script>
</body>
</html>
